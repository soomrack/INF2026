#include <stdio.h>
#include <Windows.h>
#include <clocale>
#include <fstream>

using RUB = long long int;
using percent = float;


struct bank
{
	RUB account;
	RUB deposit;
	percent interest;
};


struct transport
{
	RUB gaz;
	RUB value;
	RUB service;
	RUB tires;
	RUB oil;
};


struct house
{
	RUB h_price; // цена дома
	percent credit;
	double rate;
	bool has_house;
	bool has_credit; // условия для покупки дома и выплаты кредита
	RUB payment;
	RUB down_payment;
	RUB debt;
};



struct Person
{
	bank vtb;

	RUB salary;
	RUB food;
	RUB cat;
	RUB dog;
	RUB rent;

	transport car;
	transport metro;

	house House;
};


struct Person Biba;
struct Person Boba;


struct MonthlyStats
{
	// Доходы
	RUB total_income;
	RUB salary_income;
	RUB deposit_income;

	// Расходы
	RUB total_expenses;
	RUB food_expense;
	RUB pets_expense;
	RUB rent_expense;

	// Транспорт
	RUB transport_total;
	RUB gaz_expense;
	RUB service_expense;

	// Дом
	RUB house_total;
	RUB house_payment;
	RUB house_interest;

	// Капитал
	RUB capital;
};


void Biba_init()
{
	Biba.vtb.account = 0;
	Biba.salary = 150'000;
	Biba.vtb.deposit = 1'000'000;
	Biba.vtb.interest = 8;

	Biba.food = 20'000;
	Biba.rent = 30'000;
	Biba.cat = 0; // кота нет
	Biba.dog = 10'000;

	Biba.car.value = 2'400'000;
	Biba.car.gaz = 8'000;
	Biba.car.service = 3'000;
	Biba.car.tires = 25'000;
	Biba.car.oil = 5'000;

	Biba.House.has_house = false;
	Biba.House.has_credit = false;
}


void Boba_init()
{
	Boba.vtb.account = 0;
	Boba.salary = 80'000;
	Boba.vtb.deposit = 300'000;
	Boba.vtb.interest = 8;

	Boba.food = 20'000;
	Boba.cat = 10'000;
	Boba.dog = 0; // пса нет
	Boba.rent = 25'000;

	Boba.metro.gaz = 3'000;
}


void Biba_salary(const int month, const int year)
{
	if (month == 12)
	{
		Biba.vtb.account += Biba.salary; // 13-я зарплата
	}

	if (month == 5 and year == 2044)
	{
		Biba.salary += 30'000; // повышение
	}
	Biba.vtb.account += Biba.salary;
}


void Boba_salary(const int month, const int year)
{
	if (month == 12)
	{
		Boba.vtb.account += Boba.salary; // 13-я зарплата
	}

	if (month == 5 and year == 2040)
	{
		Boba.salary += 20'000; // повышение
	}
	Boba.vtb.account += Boba.salary;
}


void Biba_wastes()
{
	Biba.vtb.account -= Biba.food;
	Biba.vtb.account -= Biba.rent;
	// кота нет
	Biba.vtb.account -= Biba.dog;
}


void Biba_car(const int month, const int year)
{
	Biba.vtb.account -= Biba.car.gaz;
	if (month == 3 or month == 9)
	{
		Biba.vtb.account -= Biba.car.oil;
		Biba.vtb.account -= Biba.car.service; // сервис и замена масла 2 раза в год
	}

	if (year % 4 == 0 and month == 10)
	{
		Biba.vtb.account -= Biba.car.tires; // покупка новых шин
	}
}


void Boba_wastes()
{
	Boba.vtb.account -= Boba.food;
	Boba.vtb.account -= Boba.cat;
	// пса нет
	Boba.vtb.account -= Boba.rent;
	Boba.vtb.account -= Boba.metro.gaz;
}


void Biba_buy_house(int month, int year) // покупка дома
{
	if (!Biba.House.has_house and 
		Biba.vtb.deposit >= 4'000'000 and 
		month == 10 and year == 2040)
	{
		// покупка дома
		Biba.House.h_price = 15'000'000;
		Biba.House.down_payment = 2'000'000;

		// первый взнос с депозита
		Biba.vtb.deposit -= Biba.House.down_payment;

		Biba.House.has_house = true;
		Biba.House.has_credit = true;
		Biba.House.debt = Biba.House.h_price - Biba.House.down_payment;

		Biba.rent = 6'000; // расход на ренту превращается в коммунальные платежи за дом

		// вычисление процента по кредиту
		Biba.House.credit = 14;
		Biba.House.rate = Biba.House.credit / 12.0 / 100.0;

		double k = 1;
		for (int i = 0; i < 30*12; i++) // кредит на 30 лет
		{
			k *= 1 + Biba.House.rate;
		}
		Biba.House.payment = (Biba.House.debt * Biba.House.rate * k) / (k - 1);
	}
}


void Biba_credit()
{
	if (Biba.House.has_credit and Biba.House.debt > 0)
	{
		if (Biba.vtb.deposit >= Biba.House.payment)
		{
			Biba.vtb.deposit -= Biba.House.payment;

			// уменьшение долга на сумму основного долга (платеж минус проценты)
			Biba.House.debt -= Biba.House.payment -
				(Biba.House.debt * (Biba.House.credit / 12.0 / 100.0));

			if (Biba.House.debt < 0) Biba.House.debt = 0;

			if (Biba.House.debt <= 0)
			{
				Biba.House.has_credit = false;
				printf("Ипотека выплачена!\n\n");
			}
		}

		else
		{
			//здесь можно добавить штраф за просрочку
		}
	}
}

void Biba_deposite(const int month, const int year)
{
	if (year > 2045) Biba.vtb.interest = 8;
	else if (year > 2040) Biba.vtb.interest = 7.5;
	else Biba.vtb.interest = 7.8;

	Biba.vtb.deposit += Biba.vtb.deposit * (Biba.vtb.interest / 12 / 100.0);

	Biba.vtb.deposit += Biba.vtb.account; //остаток положил в депозит
	Biba.vtb.account = 0;
}


void Boba_deposite(const int month, const int year)
{
	if (year > 2045) Boba.vtb.interest = 8;
	else if (year > 2040) Boba.vtb.interest = 7.5;
	else Boba.vtb.interest = 7.8;

	Boba.vtb.deposit += Boba.vtb.deposit * (Boba.vtb.interest / 12 / 100.0);

	Boba.vtb.deposit += Boba.vtb.account;
	Boba.vtb.account = 0;
}


MonthlyStats calculate_biba_stats(int month, int year)
{
	MonthlyStats s;

	// доходы
	s.salary_income = (month == 12) ? Biba.salary * 2 : Biba.salary;
	s.deposit_income = Biba.vtb.deposit * (Biba.vtb.interest / 12.0 / 100.0);
	s.total_income = s.salary_income + s.deposit_income;

	// расходы (базовые)
	s.food_expense = Biba.food;
	s.pets_expense = Biba.dog;
	s.rent_expense = Biba.rent;
	RUB base_expenses = s.food_expense + s.pets_expense + s.rent_expense;

	// транспорт
	s.gaz_expense = Biba.car.gaz;
	s.service_expense = 0;
	if (month == 3 || month == 9) {
		s.service_expense = Biba.car.service + Biba.car.oil;
	}
	if (year % 4 == 0 && month == 10) {
		s.service_expense += Biba.car.tires;
	}
	s.transport_total = s.gaz_expense + s.service_expense;

	// дом (если есть ипотека)
	s.house_payment = Biba.House.has_credit ? Biba.House.payment : 0;
	s.house_interest = 0;
	s.house_total = 0;
	if (Biba.House.has_credit) {
		s.house_interest = Biba.House.debt * (Biba.House.credit / 12.0 / 100.0);
		s.house_total = s.house_payment;
	}

	// общие расходы
	s.total_expenses = base_expenses + s.transport_total + s.house_total;

	// капитал
	s.capital = Biba.vtb.account + Biba.vtb.deposit + Biba.car.value;
	if (Biba.House.has_house) {
		s.capital += (Biba.House.h_price - Biba.House.debt);
	}

	return s;
}


MonthlyStats calculate_boba_stats(int month, int year)
{
	MonthlyStats s;

	// доходы
	s.salary_income = (month == 12) ? Boba.salary * 2 : Boba.salary;
	s.deposit_income = Boba.vtb.deposit * (Boba.vtb.interest / 12.0 / 100.0);
	s.total_income = s.salary_income + s.deposit_income;

	// расходы
	s.food_expense = Boba.food;
	s.pets_expense = Boba.cat;
	s.rent_expense = Boba.rent;
	s.gaz_expense = Boba.metro.gaz;
	s.service_expense = 0;

	s.transport_total = s.gaz_expense;
	s.total_expenses = s.food_expense + s.pets_expense + s.rent_expense + s.transport_total;

	// дом (нет)
	s.house_payment = 0;
	s.house_interest = 0;
	s.house_total = 0;

	// капитал
	s.capital = Boba.vtb.account + Boba.vtb.deposit;

	return s;
}


void save_to_csv(int year, int month, const char* person,
	RUB account, RUB deposit, const MonthlyStats& s)
{
	std::ofstream file("simulation.csv", std::ios::app);

	// Проверка новый ли файл
	static bool first = true;
	if (first) {
		file.seekp(0, std::ios::end);
		if (file.tellp() == 0) {
			file << "Год;Месяц;Персонаж;"
				<< "Счет;Депозит;"
				<< "Доход_всего;Зарплата;Доход_депозит;"
				<< "Расходы_всего;Еда;Животные;Аренда;"
				<< "Транспорт_всего;Бензин;Обслуживание;"
				<< "Дом_всего;Платеж;Проценты;"
				<< "Капитал\n";
		}
		first = false;
	}

	file << year << ";" 
		<< month << ";" 
		<< person << ";"
		<< account << ";" 
		<< deposit << ";"
		<< s.total_income << ";" 
		<< s.salary_income << ";" 
		<< s.deposit_income << ";"
		<< s.total_expenses << ";" 
		<< s.food_expense << ";" 
		<< s.pets_expense << ";" 
		<< s.rent_expense << ";"
		<< s.transport_total << ";" 
		<< s.gaz_expense << ";" 
		<< s.service_expense << ";"
		<< s.house_total << ";" 
		<< s.house_payment << ";" 
		<< s.house_interest << ";"
		<< s.capital << "\n";

	file.close();
}


void five_year_result(const int year, const int month)
{
	if (year % 5 == 0 and month == 12)
	{
		printf("Год: %d\n\n", year);
		printf("Депозит Бибы: %lld\n", Biba.vtb.deposit);
		if (Biba.House.credit)
		{
			printf("Остаток долга: %lld\n\n", Biba.House.debt);
		}
		else
		{
			printf("Дом не куплен\n\n");
		}

		printf("Депозит Бобы: %lld\n\n", Boba.vtb.deposit);
	}
}


void result()
{
	printf("=== РЕЗУЛЬТАТ ===\n\n");
	printf("Зарплата Бибы на 2050: %lld\n", Biba.salary);

	// накопления Бибы
	RUB capital = 0;
	capital += Biba.vtb.account;
	capital += Biba.vtb.deposit;
	capital += Biba.car.value;
	capital += (Biba.House.h_price - Biba.House.debt);
	printf("Капитал Бибы на 2050: %lld\n\n", capital);

	printf("Зарплата Бобы на 2050: %lld\n", Boba.salary);

	// накопления Бобы
	capital = 0;
	capital += Boba.vtb.account;
	capital += Boba.vtb.deposit;
	printf("Капитал Бобы на 2050: %lld\n", capital);
}


int main()
{
	SetConsoleCP(1251);
	SetConsoleOutputCP(1251);
	setlocale(LC_ALL, "Russian");

	printf("=== НАЧАЛО СИМУЛЯЦИИ ===\n\n");

	int month = 3;
	int year = 2030;

	Biba_init();
	Boba_init();

	while (not (month == 3 and year == 2050))
	{
		Biba_salary(month, year);
		Biba_wastes();
		Biba_car(month, year);

		Biba_buy_house(month, year);
		Biba_credit();

		Biba_deposite(month, year);

		Boba_salary(month, year);
		Boba_wastes();
		Boba_deposite(month, year);

		RUB biba_capital = Biba.vtb.account + Biba.vtb.deposit + Biba.car.value +
			(Biba.House.has_house ? Biba.House.h_price - Biba.House.debt : 0);

		// расчёт и сохранение данных в таблицу
		MonthlyStats biba_stats = calculate_biba_stats(month, year);
		save_to_csv(year, month, "Биба",
			Biba.vtb.account, Biba.vtb.deposit,
			biba_stats);

		MonthlyStats boba_stats = calculate_boba_stats(month, year);
		save_to_csv(year, month, "Боба",
			Boba.vtb.account, Boba.vtb.deposit,
			boba_stats);

		month++;
		if (month == 13)
		{
			year++;
			month = 1;
		}

		five_year_result(year, month);
	}

	result();

	return 0;
}